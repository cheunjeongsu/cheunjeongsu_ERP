<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.spring.my.BoardMapper">
	<sql id="find">
		<if test="findkey=='subject'">
			WHERE subject LIKE '%' || #{findvalue} || '%'
		</if>
		<if test="findkey=='content'">
			WHERE content LIKE '%' || #{findvalue} || '%'
		</if>
		<if test="findkey=='subcon'">
			WHERE subject LIKE '%' || #{findvalue} || '%'
			OR content LIKE '%' || #{findvalue} || '%'
		</if>
		<if test="findkey=='userid'">
			WHERE userid LIKE '%' || #{findvalue} || '%'
		</if>
	</sql>
	
	<!-- 게시물 갯수 -->
	<select id="selectTotCnt" resultType="int">
		SELECT COUNT(*) TOTCNT FROM BOARD
		<include refid="find"/>
	</select>
	
	

	<insert id="insert" parameterType="Board">
		<selectKey keyProperty="bnum" resultType="int" order="BEFORE">
			select bseq.nextval from dual
		</selectKey>
		INSERT INTO BOARD(bnum, userid, subject, content, ip)
		VALUES (#{bnum}, #{userid}, #{subject}, #{content}, #{ip})
	</insert>
	
	<update id ="update">
		update board
			set subject = #{subject}, 
			content = #{content}, 
			ip = #{ip},
			modifydate = sysdate
		where bnum = #{bnum}
	</update>
	
	<!-- 게시물삭제 -->
	<update id="delete">
		UPDATE BOARD
		SET REMOVEYN = 'y'
		WHERE BNUM = #{bnum}
	</update>
	
	
	<select id="selectList"  resultType="java.util.Map">
		SELECT B.* FROM (
	    	SELECT ROWNUM RN, B.* FROM (
        		SELECT B.*, R.RCNT
        		FROM BOARD B LEFT JOIN 
            	(SELECT BNUM , COUNT(*) RCNT
              		FROM REPLY
             	GROUP BY BNUM) R
              	ON (B.BNUM = R.BNUM)
	        	<include refid="find"/>
            	ORDER BY B.BNUM DESC        
        	) B)B
		WHERE B.RN BETWEEN #{startNum} AND #{endNum}
		
	</select>
	
	<select id="selectOne" resultType="java.util.Map">
		SELECT B.*, UM.STATE
		FROM BOARD B LEFT JOIN 
		    (SELECT * FROM USERMANAGE
		      WHERE GUBUN = '1'
		        AND USERID = #{userid}) UM 
		ON (B.BNUM = UM.NUM)
		WHERE B.BNUM = #{bnum}
	</select>
	
	<!-- 조회수 +1 -->
	<update id="updateReadCnt">
		update board
		set readcnt = readcnt +1
		where bnum = #{bnum}	
	</update>
	
	<!-- 좋아요 +1 -->
	<update id="updateLikeCnt">
		UPDATE BOARD
		SET LIKECNT = LIKECNT +1
		WHERE BNUM = #{bnum}
	</update>
	<!-- 좋아요 -1 -->
	<update id="updateLikeCntCancel">
		UPDATE BOARD
		SET LiKECNT = LIKECNT -1
		WHERE BNUM = #{bnum}
	
	</update>
	
	<!-- 싫어요 +1 -->
	<update id="updateDisLikeCnt">
		UPDATE BOARD
		SET DISLIKECNT = DISLIKECNT +1
		WHERE BNUM = #{bnum}
	</update>
	
	<!-- 싫어요 -1 -->
	<update id="updateDisLikeCntCancel">
		UPDATE BOARD
		SET DISLIKECNT = DISLIKECNT -1
		WHERE BNUM = #{bnum}
	</update>
	
</mapper>